apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: oasys360
data:
  01-init-multitenant.sql: |
    -- Enable required extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";
    CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";
    
    -- Create database for multi-tenant setup
    CREATE DATABASE oasys360;
    
    -- Connect to the database
    \c oasys360;
    
    -- Enable Row Level Security
    ALTER DATABASE oasys360 SET row_security = on;
    
    -- Create tenant isolation function
    CREATE OR REPLACE FUNCTION get_current_tenant_id()
    RETURNS UUID AS $$
    BEGIN
        RETURN current_setting('app.current_tenant_id', true)::UUID;
    EXCEPTION
        WHEN OTHERS THEN
            RETURN NULL;
    END;
    $$ LANGUAGE plpgsql;
    
    -- Create tenant validation function
    CREATE OR REPLACE FUNCTION validate_tenant_access(tenant_id UUID)
    RETURNS BOOLEAN AS $$
    BEGIN
        RETURN tenant_id = get_current_tenant_id();
    EXCEPTION
        WHEN OTHERS THEN
            RETURN FALSE;
    END;
    $$ LANGUAGE plpgsql;
    
    -- Create audit logging function
    CREATE OR REPLACE FUNCTION log_tenant_operation()
    RETURNS TRIGGER AS $$
    BEGIN
        -- Log the operation for audit purposes
        INSERT INTO audit_logs (
            tenant_id,
            table_name,
            operation,
            old_data,
            new_data,
            timestamp,
            user_id
        ) VALUES (
            get_current_tenant_id(),
            TG_TABLE_NAME,
            TG_OP,
            CASE WHEN TG_OP = 'DELETE' THEN row_to_json(OLD) ELSE NULL END,
            CASE WHEN TG_OP IN ('INSERT', 'UPDATE') THEN row_to_json(NEW) ELSE NULL END,
            NOW(),
            current_setting('app.current_user_id', true)::INTEGER
        );
        
        RETURN COALESCE(NEW, OLD);
    END;
    $$ LANGUAGE plpgsql;
    
    -- Create performance monitoring function
    CREATE OR REPLACE FUNCTION get_tenant_performance_metrics(tenant_id UUID)
    RETURNS JSON AS $$
    DECLARE
        result JSON;
    BEGIN
        SELECT json_build_object(
            'tenant_id', tenant_id,
            'total_queries', COUNT(*),
            'avg_query_time', AVG(mean_exec_time),
            'max_query_time', MAX(mean_exec_time),
            'total_calls', SUM(calls)
        ) INTO result
        FROM pg_stat_statements
        WHERE query LIKE '%tenant_id%' AND query LIKE tenant_id::TEXT;
        
        RETURN result;
    END;
    $$ LANGUAGE plpgsql;
  
  02-create-schemas.sql: |
    -- Create schemas for multi-tenant setup
    \c oasys360;
    
    -- Create public schema for shared data
    CREATE SCHEMA IF NOT EXISTS public;
    
    -- Create tenant schemas (will be created dynamically)
    -- This is handled by Django-tenants
    
    -- Create audit schema
    CREATE SCHEMA IF NOT EXISTS audit;
    
    -- Create monitoring schema
    CREATE SCHEMA IF NOT EXISTS monitoring;
    
    -- Set search path
    ALTER DATABASE oasys360 SET search_path = public, audit, monitoring;
  
  03-create-audit-tables.sql: |
    -- Create audit tables
    \c oasys360;
    
    CREATE TABLE IF NOT EXISTS audit.audit_logs (
        id SERIAL PRIMARY KEY,
        tenant_id UUID NOT NULL,
        table_name VARCHAR(255) NOT NULL,
        operation VARCHAR(10) NOT NULL,
        old_data JSONB,
        new_data JSONB,
        timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        user_id INTEGER,
        ip_address INET,
        user_agent TEXT
    );
    
    -- Create indexes for audit logs
    CREATE INDEX IF NOT EXISTS idx_audit_logs_tenant_id ON audit.audit_logs(tenant_id);
    CREATE INDEX IF NOT EXISTS idx_audit_logs_timestamp ON audit.audit_logs(timestamp);
    CREATE INDEX IF NOT EXISTS idx_audit_logs_operation ON audit.audit_logs(operation);
    CREATE INDEX IF NOT EXISTS idx_audit_logs_table_name ON audit.audit_logs(table_name);
    
    -- Create tenant performance metrics table
    CREATE TABLE IF NOT EXISTS monitoring.tenant_metrics (
        id SERIAL PRIMARY KEY,
        tenant_id UUID NOT NULL,
        metric_name VARCHAR(255) NOT NULL,
        metric_value NUMERIC NOT NULL,
        timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        labels JSONB
    );
    
    -- Create indexes for tenant metrics
    CREATE INDEX IF NOT EXISTS idx_tenant_metrics_tenant_id ON monitoring.tenant_metrics(tenant_id);
    CREATE INDEX IF NOT EXISTS idx_tenant_metrics_timestamp ON monitoring.tenant_metrics(timestamp);
    CREATE INDEX IF NOT EXISTS idx_tenant_metrics_name ON monitoring.tenant_metrics(metric_name);
  
  04-create-rls-policies.sql: |
    -- Create Row Level Security policies
    \c oasys360;
    
    -- Enable RLS on audit tables
    ALTER TABLE audit.audit_logs ENABLE ROW LEVEL SECURITY;
    ALTER TABLE monitoring.tenant_metrics ENABLE ROW LEVEL SECURITY;
    
    -- Create RLS policies for audit logs
    CREATE POLICY tenant_audit_logs_policy ON audit.audit_logs
        FOR ALL TO PUBLIC
        USING (tenant_id = get_current_tenant_id());
    
    -- Create RLS policies for tenant metrics
    CREATE POLICY tenant_metrics_policy ON monitoring.tenant_metrics
        FOR ALL TO PUBLIC
        USING (tenant_id = get_current_tenant_id());
    
    -- Create function to set tenant context
    CREATE OR REPLACE FUNCTION set_tenant_context(tenant_id UUID, user_id INTEGER DEFAULT NULL)
    RETURNS VOID AS $$
    BEGIN
        PERFORM set_config('app.current_tenant_id', tenant_id::TEXT, false);
        IF user_id IS NOT NULL THEN
            PERFORM set_config('app.current_user_id', user_id::TEXT, false);
        END IF;
    END;
    $$ LANGUAGE plpgsql;
  
  05-create-performance-views.sql: |
    -- Create performance monitoring views
    \c oasys360;
    
    -- Create view for tenant performance metrics
    CREATE OR REPLACE VIEW monitoring.tenant_performance AS
    SELECT 
        tenant_id,
        DATE_TRUNC('hour', timestamp) as hour,
        COUNT(*) as total_operations,
        AVG(metric_value) as avg_response_time,
        MAX(metric_value) as max_response_time,
        MIN(metric_value) as min_response_time
    FROM monitoring.tenant_metrics
    WHERE metric_name = 'response_time'
    GROUP BY tenant_id, DATE_TRUNC('hour', timestamp)
    ORDER BY hour DESC;
    
    -- Create view for tenant resource usage
    CREATE OR REPLACE VIEW monitoring.tenant_resource_usage AS
    SELECT 
        tenant_id,
        DATE_TRUNC('day', timestamp) as day,
        metric_name,
        AVG(metric_value) as avg_value,
        MAX(metric_value) as max_value,
        MIN(metric_value) as min_value
    FROM monitoring.tenant_metrics
    WHERE metric_name IN ('cpu_usage', 'memory_usage', 'disk_usage')
    GROUP BY tenant_id, DATE_TRUNC('day', timestamp), metric_name
    ORDER BY day DESC, metric_name;
    
    -- Create view for tenant query performance
    CREATE OR REPLACE VIEW monitoring.tenant_query_performance AS
    SELECT 
        tenant_id,
        DATE_TRUNC('hour', timestamp) as hour,
        COUNT(*) as total_queries,
        AVG(metric_value) as avg_query_time,
        MAX(metric_value) as max_query_time
    FROM monitoring.tenant_metrics
    WHERE metric_name = 'query_time'
    GROUP BY tenant_id, DATE_TRUNC('hour', timestamp)
    ORDER BY hour DESC;
